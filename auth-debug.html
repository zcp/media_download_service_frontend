<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>认证调试页面</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .section { margin-bottom: 20px; padding: 15px; border: 1px solid #ddd; border-radius: 5px; }
        .success { background-color: #d4edda; }
        .error { background-color: #f8d7da; }
        .warning { background-color: #fff3cd; }
        pre { background: #f8f9fa; padding: 10px; border-radius: 3px; overflow-x: auto; }
        button { padding: 10px 15px; margin: 5px; cursor: pointer; }
    </style>
</head>
<body>
    <h1>认证状态调试工具</h1>
    
    <div class="section">
        <h2>当前状态检查</h2>
        <button onclick="checkCurrentState()">检查当前状态</button>
        <div id="current-state"></div>
    </div>
    
    <div class="section">
        <h2>Token 操作</h2>
        <button onclick="clearToken()">清除 Token</button>
        <button onclick="setTestToken()">设置测试 Token</button>
        <input type="text" id="manual-token" placeholder="手动输入Token" style="width: 300px;">
        <button onclick="setManualToken()">设置手动Token</button>
        <div id="token-operations"></div>
    </div>
    
    <div class="section">
        <h2>重定向测试</h2>
        <button onclick="testRedirect()">测试登录跳转</button>
        <button onclick="simulateCallback()">模拟登录回调</button>
        <div id="redirect-test"></div>
    </div>
    
    <div class="section">
        <h2>Storage 检查</h2>
        <button onclick="checkStorage()">检查存储状态</button>
        <button onclick="clearStorage()">清除所有存储</button>
        <div id="storage-check"></div>
    </div>

    <script>
        function checkCurrentState() {
            const result = document.getElementById('current-state');
            
            const token = localStorage.getItem('jwt_token');
            const redirectPath = localStorage.getItem('auth_redirect_path');
            
            let html = '<h3>当前状态:</h3>';
            
            if (token) {
                html += '<div class="success">✅ Token 存在</div>';
                try {
                    const payload = JSON.parse(atob(token.split('.')[1]));
                    const currentTime = Date.now() / 1000;
                    const isExpired = payload.exp <= currentTime;
                    
                    html += '<pre>' + JSON.stringify({
                        token: token.substring(0, 50) + '...',
                        exp: payload.exp,
                        currentTime,
                        isExpired,
                        timeLeft: Math.round(payload.exp - currentTime),
                        user: payload
                    }, null, 2) + '</pre>';
                    
                    if (isExpired) {
                        html += '<div class="error">❌ Token 已过期</div>';
                    } else {
                        html += '<div class="success">✅ Token 有效</div>';
                    }
                } catch (e) {
                    html += '<div class="error">❌ Token 格式错误: ' + e.message + '</div>';
                }
            } else {
                html += '<div class="warning">⚠️ 没有 Token</div>';
            }
            
            if (redirectPath) {
                html += '<div class="warning">⚠️ 保存的重定向路径: ' + redirectPath + '</div>';
            }
            
            result.innerHTML = html;
        }
        
        function clearToken() {
            localStorage.removeItem('jwt_token');
            document.getElementById('token-operations').innerHTML = '<div class="success">✅ Token 已清除</div>';
        }
        
        function setTestToken() {
            // 创建一个未过期的测试Token
            const header = btoa(JSON.stringify({typ: "JWT", alg: "HS256"}));
            const payload = btoa(JSON.stringify({
                user_id: "test-user-123",
                username: "测试用户",
                email: "test@example.com",
                exp: Math.floor(Date.now() / 1000) + 3600 // 1小时后过期
            }));
            const signature = "test-signature";
            const testToken = `${header}.${payload}.${signature}`;
            
            localStorage.setItem('jwt_token', testToken);
            document.getElementById('token-operations').innerHTML = '<div class="success">✅ 测试 Token 已设置</div>';
        }
        
        function setManualToken() {
            const token = document.getElementById('manual-token').value;
            if (token) {
                localStorage.setItem('jwt_token', token);
                document.getElementById('token-operations').innerHTML = '<div class="success">✅ 手动 Token 已设置</div>';
            } else {
                document.getElementById('token-operations').innerHTML = '<div class="error">❌ 请输入 Token</div>';
            }
        }
        
        function testRedirect() {
            localStorage.setItem('auth_redirect_path', '/download-center/tasks');
            window.location.href = '/auth/callback?token=' + encodeURIComponent('test.token.here');
        }
        
        function simulateCallback() {
            localStorage.setItem('auth_redirect_path', '/download-center/tasks');
            const testToken = setTestToken();
            window.location.href = '/auth/callback?token=test.token.here';
        }
        
        function checkStorage() {
            const result = document.getElementById('storage-check');
            let html = '<h3>存储内容:</h3><pre>';
            
            html += 'localStorage:\n';
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                html += `  ${key}: ${localStorage.getItem(key)}\n`;
            }
            
            html += '\nsessionStorage:\n';
            for (let i = 0; i < sessionStorage.length; i++) {
                const key = sessionStorage.key(i);
                html += `  ${key}: ${sessionStorage.getItem(key)}\n`;
            }
            
            html += '</pre>';
            result.innerHTML = html;
        }
        
        function clearStorage() {
            localStorage.clear();
            sessionStorage.clear();
            document.getElementById('storage-check').innerHTML = '<div class="success">✅ 所有存储已清除</div>';
        }
        
        // 页面加载时自动检查状态
        window.onload = function() {
            checkCurrentState();
            checkStorage();
        };
    </script>
</body>
</html>

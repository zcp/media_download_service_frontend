import{aC as q,aB as W,r as f,c as F,h as X,al as i,ar as Y,y as Z,z as m,Q as n,I as r,A as v,u as b,M as l,O as d,J as ee,H as k,K as x}from"./vue-CG64YRnT.js";import{a as ae}from"./index-uC5IX2IK.js";import{f as te}from"./time-BU10aqh9.js";import{E as s,g as ne,e as D}from"./elementPlus-Djpklj9S.js";import{_ as re}from"./_plugin-vue_export-helper-DlAUqK2U.js";import"./utils-Dq7h7Pqt.js";const oe={class:"failures-page"},le={class:"page-header"},se={class:"header-left"},ie={class:"page-title"},ue={class:"header-right"},ce={class:"pagination-area"},de={__name:"DownloadFailures",setup(pe){const B=q(),M=W(),p=ae(),_=f(!1),g=f(1),y=f(20),C=f(new Set),z=f(new Set),u=F(()=>B.params.taskId),U=F(()=>u.value?`任务 ${u.value} 的失败记录`:"下载失败记录"),h=F(()=>!u.value);X(async()=>{await c()});const c=async()=>{_.value=!0;try{const e=h.value?null:u.value;await p.fetchFailures(e,{page:g.value,size:y.value})}catch{s.error("获取失败记录失败")}finally{_.value=!1}},E=async()=>{await c(),s.success("刷新成功")},N=async e=>{try{if(await D.confirm("确定要重试此失败资源吗？","确认重试",{type:"warning"}),C.value.add(e),h.value){s.warning("全局失败记录页面暂不支持重试操作，请到具体任务页面操作");return}await p.retryFailure(u.value,e),s.success("重试成功"),await c()}catch(t){t!=="cancel"&&s.error("重试失败")}finally{C.value.delete(e)}},R=async e=>{try{if(await D.confirm("确定要放弃此失败资源吗？","确认放弃",{type:"warning"}),z.value.add(e),h.value){s.warning("全局失败记录页面暂不支持放弃操作，请到具体任务页面操作");return}await p.abandonFailure(u.value,e),s.success("已放弃"),await c()}catch(t){t!=="cancel"&&s.error("操作失败")}finally{z.value.delete(e)}},V=async e=>{y.value=e,g.value=1,await c()},$=async e=>{g.value=e,await c()},H=()=>M.back(),A=e=>e.length>50?`${e.slice(0,50)}...`:e,I=e=>({network_error:"网络错误",timeout:"超时",invalid_content:"内容无效",storage_error:"存储错误",permission_error:"权限错误"})[e]||e,P=e=>({network_error:"danger",timeout:"warning",invalid_content:"danger",storage_error:"danger",permission_error:"warning"})[e]||"",j=e=>({pending:"待重试",retrying:"重试中",abandoned:"已放弃"})[e]||e,G=e=>({pending:"warning",retrying:"primary",abandoned:"info"})[e]||"";return(e,t)=>{const w=i("el-button"),S=i("el-card"),o=i("el-table-column"),J=i("el-link"),T=i("el-tag"),K=i("el-table"),L=i("el-pagination"),O=Y("loading");return m(),Z("div",oe,[n(S,{class:"header-card",shadow:"never"},{default:r(()=>[v("div",le,[v("div",se,[n(w,{onClick:H,icon:b(ne),type:"text"},{default:r(()=>t[2]||(t[2]=[l("返回")])),_:1,__:[2]},8,["icon"]),v("h2",ie,d(U.value),1)]),v("div",ue,[n(w,{onClick:E,loading:_.value},{default:r(()=>t[3]||(t[3]=[l("刷新")])),_:1,__:[3]},8,["loading"])])])]),_:1}),n(S,{class:"table-card",shadow:"never"},{default:r(()=>[ee((m(),k(K,{data:b(p).failures,loading:_.value,border:"",stripe:"",height:"600"},{default:r(()=>[n(o,{prop:"id",label:"失败ID",width:"280","show-overflow-tooltip":""}),n(o,{prop:"resource_url",label:"资源URL",width:"300","show-overflow-tooltip":""},{default:r(({row:a})=>[n(J,{href:a.resource_url,target:"_blank",type:"primary"},{default:r(()=>[l(d(A(a.resource_url)),1)]),_:2},1032,["href"])]),_:1}),n(o,{prop:"resource_type",label:"资源类型",width:"100"},{default:r(({row:a})=>[n(T,{size:"small"},{default:r(()=>[l(d(a.resource_type.toUpperCase()),1)]),_:2},1024)]),_:1}),n(o,{prop:"failure_type",label:"失败类型",width:"120"},{default:r(({row:a})=>[n(T,{type:P(a.failure_type),size:"small"},{default:r(()=>[l(d(I(a.failure_type)),1)]),_:2},1032,["type"])]),_:1}),n(o,{prop:"error_message",label:"错误信息",width:"250","show-overflow-tooltip":""}),n(o,{prop:"retry_count",label:"重试次数",width:"100",align:"center"}),n(o,{prop:"status",label:"状态",width:"100"},{default:r(({row:a})=>[n(T,{type:G(a.status),size:"small"},{default:r(()=>[l(d(j(a.status)),1)]),_:2},1032,["type"])]),_:1}),n(o,{prop:"created_at",label:"创建时间",width:"160"},{default:r(({row:a})=>[l(d(b(te)(a.created_at,"MM-DD HH:mm")),1)]),_:1}),h.value?x("",!0):(m(),k(o,{key:0,label:"操作",width:"200",fixed:"right"},{default:r(({row:a})=>[a.status==="pending"?(m(),k(w,{key:0,size:"small",type:"warning",onClick:Q=>N(a.id),loading:C.value.has(a.id)},{default:r(()=>t[4]||(t[4]=[l(" 重试 ")])),_:2,__:[4]},1032,["onClick","loading"])):x("",!0),a.status!=="abandoned"?(m(),k(w,{key:1,size:"small",type:"danger",onClick:Q=>R(a.id),loading:z.value.has(a.id)},{default:r(()=>t[5]||(t[5]=[l(" 放弃 ")])),_:2,__:[5]},1032,["onClick","loading"])):x("",!0)]),_:1}))]),_:1},8,["data","loading"])),[[O,_.value]]),v("div",ce,[n(L,{"current-page":g.value,"onUpdate:currentPage":t[0]||(t[0]=a=>g.value=a),"page-size":y.value,"onUpdate:pageSize":t[1]||(t[1]=a=>y.value=a),"page-sizes":[10,20,50,100],total:b(p).failuresTotal,layout:"total, sizes, prev, pager, next, jumper",onSizeChange:V,onCurrentChange:$},null,8,["current-page","page-size","total"])])]),_:1})])}}},he=re(de,[["__scopeId","data-v-c5ecb77b"]]);export{he as default};

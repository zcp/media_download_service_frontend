import{aC as O,aB as Q,r as g,c as q,h as G,al as l,ar as W,y as X,z as h,Q as o,I as n,A as m,u as w,M as s,O as d,J as Y,H as z,K as F}from"./vue-CG64YRnT.js";import{a as Z}from"./index-DpMErgrC.js";import{f as ee}from"./time-BU10aqh9.js";import{E as c,g as ae,e as S}from"./elementPlus-Djpklj9S.js";import{_ as te}from"./_plugin-vue_export-helper-DlAUqK2U.js";import"./utils-Dq7h7Pqt.js";const oe={class:"failures-page"},ne={class:"page-header"},re={class:"header-left"},se={class:"page-title"},le={class:"header-right"},ie={class:"pagination-area"},de={__name:"DownloadFailures",setup(ce){const T=O(),D=Q(),u=Z(),p=g(!1),_=g(1),f=g(20),b=g(new Set),k=g(new Set),v=q(()=>T.params.taskId);G(async()=>{await i()});const i=async()=>{p.value=!0;try{await u.fetchFailures(v.value,{page:_.value,size:f.value})}catch{c.error("获取失败记录失败")}finally{p.value=!1}},B=async()=>{await i(),c.success("刷新成功")},M=async e=>{try{await S.confirm("确定要重试此失败资源吗？","确认重试",{type:"warning"}),b.value.add(e),await u.retryFailure(v.value,e),c.success("重试成功"),await i()}catch(t){t!=="cancel"&&c.error("重试失败")}finally{b.value.delete(e)}},U=async e=>{try{await S.confirm("确定要放弃此失败资源吗？","确认放弃",{type:"warning"}),k.value.add(e),await u.abandonFailure(v.value,e),c.success("已放弃"),await i()}catch(t){t!=="cancel"&&c.error("操作失败")}finally{k.value.delete(e)}},E=async e=>{f.value=e,_.value=1,await i()},N=async e=>{_.value=e,await i()},R=()=>D.back(),V=e=>e.length>50?`${e.slice(0,50)}...`:e,H=e=>({network_error:"网络错误",timeout:"超时",invalid_content:"内容无效",storage_error:"存储错误",permission_error:"权限错误"})[e]||e,$=e=>({network_error:"danger",timeout:"warning",invalid_content:"danger",storage_error:"danger",permission_error:"warning"})[e]||"",A=e=>({pending:"待重试",retrying:"重试中",abandoned:"已放弃"})[e]||e,P=e=>({pending:"warning",retrying:"primary",abandoned:"info"})[e]||"";return(e,t)=>{const y=l("el-button"),x=l("el-card"),r=l("el-table-column"),j=l("el-link"),C=l("el-tag"),I=l("el-table"),J=l("el-pagination"),K=W("loading");return h(),X("div",oe,[o(x,{class:"header-card",shadow:"never"},{default:n(()=>[m("div",ne,[m("div",re,[o(y,{onClick:R,icon:w(ae),type:"text"},{default:n(()=>t[2]||(t[2]=[s("返回")])),_:1,__:[2]},8,["icon"]),m("h2",se,"任务 "+d(v.value)+" 的失败记录",1)]),m("div",le,[o(y,{onClick:B,loading:p.value},{default:n(()=>t[3]||(t[3]=[s("刷新")])),_:1,__:[3]},8,["loading"])])])]),_:1}),o(x,{class:"table-card",shadow:"never"},{default:n(()=>[Y((h(),z(I,{data:w(u).failures,loading:p.value,border:"",stripe:"",height:"600"},{default:n(()=>[o(r,{prop:"id",label:"失败ID",width:"280","show-overflow-tooltip":""}),o(r,{prop:"resource_url",label:"资源URL",width:"300","show-overflow-tooltip":""},{default:n(({row:a})=>[o(j,{href:a.resource_url,target:"_blank",type:"primary"},{default:n(()=>[s(d(V(a.resource_url)),1)]),_:2},1032,["href"])]),_:1}),o(r,{prop:"resource_type",label:"资源类型",width:"100"},{default:n(({row:a})=>[o(C,{size:"small"},{default:n(()=>[s(d(a.resource_type.toUpperCase()),1)]),_:2},1024)]),_:1}),o(r,{prop:"failure_type",label:"失败类型",width:"120"},{default:n(({row:a})=>[o(C,{type:$(a.failure_type),size:"small"},{default:n(()=>[s(d(H(a.failure_type)),1)]),_:2},1032,["type"])]),_:1}),o(r,{prop:"error_message",label:"错误信息",width:"250","show-overflow-tooltip":""}),o(r,{prop:"retry_count",label:"重试次数",width:"100",align:"center"}),o(r,{prop:"status",label:"状态",width:"100"},{default:n(({row:a})=>[o(C,{type:P(a.status),size:"small"},{default:n(()=>[s(d(A(a.status)),1)]),_:2},1032,["type"])]),_:1}),o(r,{prop:"created_at",label:"创建时间",width:"160"},{default:n(({row:a})=>[s(d(w(ee)(a.created_at,"MM-DD HH:mm")),1)]),_:1}),o(r,{label:"操作",width:"200",fixed:"right"},{default:n(({row:a})=>[a.status==="pending"?(h(),z(y,{key:0,size:"small",type:"warning",onClick:L=>M(a.id),loading:b.value.has(a.id)},{default:n(()=>t[4]||(t[4]=[s(" 重试 ")])),_:2,__:[4]},1032,["onClick","loading"])):F("",!0),a.status!=="abandoned"?(h(),z(y,{key:1,size:"small",type:"danger",onClick:L=>U(a.id),loading:k.value.has(a.id)},{default:n(()=>t[5]||(t[5]=[s(" 放弃 ")])),_:2,__:[5]},1032,["onClick","loading"])):F("",!0)]),_:1})]),_:1},8,["data","loading"])),[[K,p.value]]),m("div",ie,[o(J,{"current-page":_.value,"onUpdate:currentPage":t[0]||(t[0]=a=>_.value=a),"page-size":f.value,"onUpdate:pageSize":t[1]||(t[1]=a=>f.value=a),"page-sizes":[10,20,50,100],total:w(u).failuresTotal,layout:"total, sizes, prev, pager, next, jumper",onSizeChange:E,onCurrentChange:N},null,8,["current-page","page-size","total"])])]),_:1})])}}},ve=te(de,[["__scopeId","data-v-0d6eb44a"]]);export{ve as default};

import{aB as ue,X as _e,r as x,c as me,h as fe,S as ge,al as n,ar as ve,y as ye,z as h,Q as e,I as l,A as f,M as s,O as g,u as r,V as v,J as we,H as z,K as $}from"./vue-CG64YRnT.js";import{a as ke}from"./index-DpMErgrC.js";import{f as he,a as be}from"./time-BU10aqh9.js";import{E as y,p as Ce,r as Te,c as xe,w as ze,v as Me,e as U}from"./elementPlus-Djpklj9S.js";import{_ as De}from"./_plugin-vue_export-helper-DlAUqK2U.js";import"./utils-Dq7h7Pqt.js";const Se={class:"task-list-page"},Ve={class:"operation-header"},$e={class:"header-left"},Be={class:"header-right"},Ee={class:"filter-area"},Fe={class:"action-buttons"},Re={class:"pagination-area"},Ue={__name:"DownloadTaskList",setup(Le){const b=ue(),p=ke(),d=_e({status:"",resource_type:"",liveroom_id:""}),m=x(1),C=x(20),M=x(new Set),D=x(new Set),L=me(()=>({page:m.value,size:C.value,sort:"created_at:desc",...d}));fe(async()=>{console.log("任务列表页面已挂载"),await _()}),ge(()=>{console.log("任务列表页面已卸载")});const _=async()=>{try{await p.fetchTasks(L.value)}catch(t){console.error("获取任务列表失败:",t),y.error("获取任务列表失败")}},I=async()=>{await _(),y.success("刷新成功")},B=async()=>{m.value=1,await _()},P=async()=>{Object.keys(d).forEach(t=>{d[t]=""}),m.value=1,await _()},A=async t=>{C.value=t,m.value=1,await _()},H=async t=>{m.value=t,await _()},N=()=>{b.push("/download-center/tasks/create")},S=t=>{b.push(`/download-center/tasks/${t}`)},j=t=>{b.push(`/download-center/tasks/${t}/failures`)},O=t=>{b.push(`/download-center/tasks/${t}/videos`)},J=t=>{S(t.id)},K=async t=>{try{await U.confirm("确定要重试此任务吗？","确认重试",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"}),M.value.add(t),await p.retryTask(t),y.success("任务重试成功"),await _()}catch(a){a!=="cancel"&&(console.error("重试任务失败:",a),y.error("重试任务失败"))}finally{M.value.delete(t)}},Q=async t=>{try{await U.confirm("确定要取消此任务吗？此操作不可撤销。","确认取消",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"}),D.value.add(t),await p.deleteTask(t),y.success("任务已取消"),await _()}catch(a){a!=="cancel"&&(console.error("取消任务失败:",a),y.error("取消任务失败"))}finally{D.value.delete(t)}},X=(t,a)=>{const[w,i]=t.split(":");switch(w){case"failures":j(i);break;case"videos":O(i);break}},q=t=>t.length>36?`${t.slice(0,8)}...${t.slice(-8)}`:t,G=t=>({pending:"待处理",processing:"处理中",completed:"已完成",partial_completed:"部分完成",failed:"失败",cancelled:"已取消"})[t]||t,W=t=>({pending:"",processing:"warning",completed:"success",partial_completed:"warning",failed:"danger",cancelled:"info"})[t]||"",Y=t=>({hls:"primary",mp4:"success",image:"warning"})[t]||"",Z=t=>({pending:"#909399",processing:"#409EFF",completed:"#67C23A",partial_completed:"#E6A23C",failed:"#F56C6C",cancelled:"#909399"})[t]||"#409EFF",ee=t=>["failed","cancelled"].includes(t),te=t=>["pending","processing"].includes(t),ae=t=>["failed","partial_completed"].includes(t);return(t,a)=>{const w=n("el-tag"),i=n("el-button"),u=n("el-option"),E=n("el-select"),T=n("el-form-item"),oe=n("el-input"),le=n("el-form"),F=n("el-card"),ne=n("el-link"),c=n("el-table-column"),se=n("el-progress"),V=n("el-icon"),R=n("el-dropdown-item"),re=n("el-dropdown-menu"),ie=n("el-dropdown"),de=n("el-table"),ce=n("el-pagination"),pe=ve("loading");return h(),ye("div",Se,[e(F,{class:"operation-card",shadow:"never"},{default:l(()=>[f("div",Ve,[f("div",$e,[a[6]||(a[6]=f("h2",{class:"page-title"},"下载任务列表",-1)),e(w,{type:"info",size:"large"},{default:l(()=>[s(" 共 "+g(r(p).tasksTotal)+" 个任务 ",1)]),_:1})]),f("div",Be,[e(i,{type:"primary",icon:r(Ce),onClick:N},{default:l(()=>a[7]||(a[7]=[s(" 创建任务 ")])),_:1,__:[7]},8,["icon"]),e(i,{icon:r(Te),onClick:I,loading:r(p).tasksLoading},{default:l(()=>a[8]||(a[8]=[s(" 刷新 ")])),_:1,__:[8]},8,["icon","loading"])])]),f("div",Ee,[e(le,{model:d,inline:"",onSubmit:v(B,["prevent"])},{default:l(()=>[e(T,{label:"状态"},{default:l(()=>[e(E,{modelValue:d.status,"onUpdate:modelValue":a[0]||(a[0]=o=>d.status=o),placeholder:"选择状态",clearable:"",style:{width:"140px"}},{default:l(()=>[e(u,{label:"待处理",value:"pending"}),e(u,{label:"处理中",value:"processing"}),e(u,{label:"已完成",value:"completed"}),e(u,{label:"部分完成",value:"partial_completed"}),e(u,{label:"失败",value:"failed"}),e(u,{label:"已取消",value:"cancelled"})]),_:1},8,["modelValue"])]),_:1}),e(T,{label:"资源类型"},{default:l(()=>[e(E,{modelValue:d.resource_type,"onUpdate:modelValue":a[1]||(a[1]=o=>d.resource_type=o),placeholder:"选择类型",clearable:"",style:{width:"120px"}},{default:l(()=>[e(u,{label:"HLS",value:"hls"}),e(u,{label:"MP4",value:"mp4"}),e(u,{label:"图片",value:"image"})]),_:1},8,["modelValue"])]),_:1}),e(T,{label:"直播间ID"},{default:l(()=>[e(oe,{modelValue:d.liveroom_id,"onUpdate:modelValue":a[2]||(a[2]=o=>d.liveroom_id=o),placeholder:"输入直播间ID",clearable:"",style:{width:"160px"}},null,8,["modelValue"])]),_:1}),e(T,null,{default:l(()=>[e(i,{type:"primary",onClick:B},{default:l(()=>a[9]||(a[9]=[s("搜索")])),_:1,__:[9]}),e(i,{onClick:P},{default:l(()=>a[10]||(a[10]=[s("重置")])),_:1,__:[10]})]),_:1})]),_:1},8,["model"])])]),_:1}),e(F,{class:"table-card",shadow:"never"},{default:l(()=>[we((h(),z(de,{data:r(p).tasks,loading:r(p).tasksLoading,border:"",stripe:"",height:"600",onRowClick:J,"element-loading-text":"加载中..."},{default:l(()=>[e(c,{prop:"id",label:"任务ID",width:"280","show-overflow-tooltip":""},{default:l(({row:o})=>[e(ne,{type:"primary",onClick:v(k=>S(o.id),["stop"])},{default:l(()=>[s(g(q(o.id)),1)]),_:2},1032,["onClick"])]),_:1}),e(c,{prop:"video_id",label:"视频ID",width:"200","show-overflow-tooltip":""}),e(c,{prop:"liveroom_id",label:"直播间ID",width:"120"}),e(c,{prop:"resource_type",label:"资源类型",width:"100"},{default:l(({row:o})=>[e(w,{type:Y(o.resource_type),size:"small"},{default:l(()=>[s(g(o.resource_type.toUpperCase()),1)]),_:2},1032,["type"])]),_:1}),e(c,{prop:"status",label:"状态",width:"120"},{default:l(({row:o})=>[e(w,{type:W(o.status),size:"small"},{default:l(()=>[s(g(G(o.status)),1)]),_:2},1032,["type"])]),_:1}),e(c,{prop:"progress",label:"进度",width:"120"},{default:l(({row:o})=>[e(se,{percentage:Math.round(o.progress*100),color:Z(o.status),"show-text":!0,"text-inside":"","stroke-width":"16"},null,8,["percentage","color"])]),_:1}),e(c,{prop:"retry_count",label:"重试次数",width:"100",align:"center"}),e(c,{prop:"created_at",label:"创建时间",width:"160"},{default:l(({row:o})=>[s(g(r(he)(o.created_at,"MM-DD HH:mm")),1)]),_:1}),e(c,{prop:"updated_at",label:"更新时间",width:"160"},{default:l(({row:o})=>[s(g(r(be)(o.updated_at)),1)]),_:1}),e(c,{label:"操作",width:"300",fixed:"right"},{default:l(({row:o})=>[f("div",Fe,[e(i,{size:"small",type:"primary",onClick:v(k=>S(o.id),["stop"])},{default:l(()=>a[11]||(a[11]=[s(" 详情 ")])),_:2,__:[11]},1032,["onClick"]),ee(o.status)?(h(),z(i,{key:0,size:"small",type:"warning",onClick:v(k=>K(o.id),["stop"]),loading:M.value.has(o.id)},{default:l(()=>a[12]||(a[12]=[s(" 重试 ")])),_:2,__:[12]},1032,["onClick","loading"])):$("",!0),te(o.status)?(h(),z(i,{key:1,size:"small",type:"danger",onClick:v(k=>Q(o.id),["stop"]),loading:D.value.has(o.id)},{default:l(()=>a[13]||(a[13]=[s(" 取消 ")])),_:2,__:[13]},1032,["onClick","loading"])):$("",!0),e(ie,{onCommand:k=>X(k,o),onClick:a[3]||(a[3]=v(()=>{},["stop"]))},{dropdown:l(()=>[e(re,null,{default:l(()=>[ae(o.status)?(h(),z(R,{key:0,command:`failures:${o.id}`},{default:l(()=>[e(V,null,{default:l(()=>[e(r(ze))]),_:1}),a[15]||(a[15]=s(" 失败记录 "))]),_:2,__:[15]},1032,["command"])):$("",!0),e(R,{command:`videos:${o.id}`},{default:l(()=>[e(V,null,{default:l(()=>[e(r(Me))]),_:1}),a[16]||(a[16]=s(" 已下载视频 "))]),_:2,__:[16]},1032,["command"])]),_:2},1024)]),default:l(()=>[e(i,{size:"small",type:"info"},{default:l(()=>[a[14]||(a[14]=s(" 更多 ")),e(V,null,{default:l(()=>[e(r(xe))]),_:1})]),_:1,__:[14]})]),_:2},1032,["onCommand"])])]),_:1})]),_:1},8,["data","loading"])),[[pe,r(p).tasksLoading]]),f("div",Re,[e(ce,{"current-page":m.value,"onUpdate:currentPage":a[4]||(a[4]=o=>m.value=o),"page-size":C.value,"onUpdate:pageSize":a[5]||(a[5]=o=>C.value=o),"page-sizes":[10,20,50,100],total:r(p).tasksTotal,layout:"total, sizes, prev, pager, next, jumper",onSizeChange:A,onCurrentChange:H},null,8,["current-page","page-size","total"])])]),_:1})])}}},Oe=De(Ue,[["__scopeId","data-v-18797f57"]]);export{Oe as default};

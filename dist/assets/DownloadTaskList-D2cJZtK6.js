import{aB as Se,X as ze,r as v,c as S,h as Be,S as Me,j as De,al as c,y as Ve,z,Q as a,I as o,A as y,M as i,O as h,u as _,D as W,V as T,H as E,K as R}from"./vue-CG64YRnT.js";import{a as Ee}from"./index-CYcOiW0B.js";import{f as Re,a as Fe}from"./time-BU10aqh9.js";import{E as s,p as Pe,r as Ue,c as Ae,w as He,v as Le,e as B}from"./elementPlus-Djpklj9S.js";import{_ as Ne}from"./_plugin-vue_export-helper-DlAUqK2U.js";import"./utils-Dq7h7Pqt.js";const je={class:"task-list-page"},Ie={class:"operation-header"},Oe={class:"header-left"},Ke={class:"operation-buttons"},Qe={class:"button-group"},Xe={class:"filter-area"},qe={class:"action-buttons"},Ge={class:"pagination-area"},Je={__name:"DownloadTaskList",setup(We){const M=Se(),d=Ee(),f=ze({status:"",resource_type:"",liveroom_id:""}),w=v(1),D=v(20),k=v(new Set),F=v(new Set),C=v(new Set),m=v([]),P=v(!1),U=v(!1),j=S(()=>({page:w.value,size:D.value,sort:"created_at:desc",...f})),$=async()=>{await d.fetchTasks(j.value,!1)},Y=e=>{m.value=e},I=S(()=>m.value.filter(e=>H(e.status)).length),O=S(()=>m.value.filter(e=>L(e.status)).length),K=S(()=>I.value>0),Q=S(()=>O.value>0);Be(async()=>{console.log("任务列表页面已挂载"),await b()}),Me(()=>{console.log("任务列表页面已卸载")}),De(()=>d.tasks,(e,t)=>{!t||t.length===0||e.forEach((n,r)=>{const u=t[r];u&&u.status!==n.status&&(n.status==="completed"?s.success(`任务 ${g(n.id)} 下载完成！`):n.status==="failed"?s.error(`任务 ${g(n.id)} 下载失败，请检查重试`):n.status==="partial_completed"&&s.warning(`任务 ${g(n.id)} 部分完成，请检查详情`))})},{deep:!0});const b=async()=>{try{await d.fetchTasks(j.value)}catch(e){console.error("获取任务列表失败:",e),s.error("获取任务列表失败")}},Z=async()=>{await b(),s.success("刷新成功")},X=async()=>{w.value=1,await b()},ee=async()=>{Object.keys(f).forEach(e=>{f[e]=""}),w.value=1,await b()},te=async e=>{D.value=e,w.value=1,await b()},ae=async e=>{w.value=e,await b()},le=()=>{M.push("/download-center/tasks/create")},A=e=>{M.push(`/download-center/tasks/${e}`)},oe=e=>{M.push(`/download-center/tasks/${e}/failures`)},ne=e=>{M.push(`/download-center/tasks/${e}/videos`)},se=e=>{A(e.id)},re=async e=>{try{await B.confirm("确定要开始下载此任务吗？","确认开始下载",{confirmButtonText:"确定",cancelButtonText:"取消",type:"info"}),C.value.add(e),s.info("正在启动下载任务，请稍候..."),d.startTask(e).then(()=>{s.success("任务开始下载成功"),setTimeout(()=>$(),1e3)}).catch(t=>{console.error("开始下载任务失败:",t),s.error("开始下载任务失败，请重试"),setTimeout(()=>$(),1e3)}).finally(()=>{C.value.delete(e)})}catch(t){t!=="cancel"&&(console.error("开始下载任务失败:",t),s.error("开始下载任务失败"))}},ie=async e=>{try{await B.confirm("确定要重试此任务吗？","确认重试",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"}),k.value.add(e),s.info("正在重试任务，请稍候..."),d.retryTask(e).then(()=>{s.success("任务重试成功"),setTimeout(()=>$(),1e3)}).catch(t=>{console.error("重试任务失败:",t),s.error("重试任务失败，请重试"),setTimeout(()=>$(),1e3)}).finally(()=>{k.value.delete(e)})}catch(t){t!=="cancel"&&(console.error("重试任务失败:",t),s.error("重试任务失败"))}},ce=async e=>{try{await B.confirm("确定要取消此任务吗？此操作不可撤销。","确认取消",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"}),F.value.add(e),await d.deleteTask(e),s.success("任务已取消"),await b()}catch(t){t!=="cancel"&&(console.error("取消任务失败:",t),s.error("取消任务失败"))}finally{F.value.delete(e)}},de=(e,t)=>{const[n,r]=e.split(":");switch(n){case"failures":oe(r);break;case"videos":ne(r);break}},ue=async()=>{const e=m.value.filter(t=>H(t.status));if(e.length===0){s.warning("没有可开始下载的任务");return}try{await B.confirm(`确定要开始下载 ${e.length} 个任务吗？`,"确认批量开始下载",{confirmButtonText:"确定",cancelButtonText:"取消",type:"info"}),P.value=!0,e.forEach(n=>C.value.add(n.id)),s.info(`正在启动 ${e.length} 个下载任务，请稍候...`);const t=e.map(n=>d.startTask(n.id).then(()=>{s.success(`任务 ${g(n.id)} 开始下载成功`)}).catch(r=>{console.error(`开始下载任务 ${n.id} 失败:`,r),s.error(`任务 ${g(n.id)} 开始下载失败`)}).finally(()=>{C.value.delete(n.id)}));await Promise.allSettled(t),setTimeout(()=>$(),1e3),s.success(`批量操作完成，成功启动 ${e.length} 个任务`)}catch(t){t!=="cancel"&&(console.error("批量开始下载失败:",t),s.error("批量开始下载失败"))}finally{P.value=!1,e.forEach(t=>C.value.delete(t.id))}},pe=async()=>{const e=m.value.filter(t=>L(t.status));if(e.length===0){s.warning("没有可重试的任务");return}try{await B.confirm(`确定要重试 ${e.length} 个任务吗？`,"确认批量重试",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"}),U.value=!0,e.forEach(n=>k.value.add(n.id)),s.info(`正在重试 ${e.length} 个任务，请稍候...`);const t=e.map(n=>d.retryTask(n.id).then(()=>{s.success(`任务 ${g(n.id)} 重试成功`)}).catch(r=>{console.error(`重试任务 ${n.id} 失败:`,r),s.error(`任务 ${g(n.id)} 重试失败`)}).finally(()=>{k.value.delete(n.id)}));await Promise.allSettled(t),await $(),s.success(`批量操作完成，成功重试 ${e.length} 个任务`)}catch(t){t!=="cancel"&&(console.error("批量重试失败:",t),s.error("批量重试失败"))}finally{U.value=!1,e.forEach(t=>k.value.delete(t.id))}},g=e=>e.length>36?`${e.slice(0,8)}...${e.slice(-8)}`:e,_e=e=>({pending:"待处理",processing:"处理中",completed:"已完成",partial_completed:"部分完成",failed:"失败",cancelled:"已取消"})[e]||e,fe=e=>({pending:"",processing:"warning",completed:"success",partial_completed:"warning",failed:"danger",cancelled:"info"})[e]||"",me=e=>({hls:"primary",mp4:"success",image:"warning"})[e]||"",ge=e=>({pending:"#909399",processing:"#409EFF",completed:"#67C23A",partial_completed:"#E6A23C",failed:"#F56C6C",cancelled:"#909399"})[e]||"#409EFF",H=e=>["pending"].includes(e),L=e=>["failed","cancelled","partial_completed"].includes(e),ve=e=>["pending","processing"].includes(e),ye=e=>["failed","partial_completed"].includes(e);return(e,t)=>{const n=c("el-tag"),r=c("el-button"),u=c("el-option"),q=c("el-select"),V=c("el-form-item"),he=c("el-input"),we=c("el-form"),G=c("el-card"),p=c("el-table-column"),be=c("el-link"),Te=c("el-progress"),N=c("el-icon"),J=c("el-dropdown-item"),ke=c("el-dropdown-menu"),Ce=c("el-dropdown"),$e=c("el-table"),xe=c("el-pagination");return z(),Ve("div",je,[a(G,{class:"operation-card",shadow:"never"},{default:o(()=>[y("div",Ie,[y("div",Oe,[t[6]||(t[6]=y("h2",{class:"page-title"},"下载任务列表",-1)),a(n,{type:"info",size:"large"},{default:o(()=>[i(" 共 "+h(_(d).tasksTotal)+" 个任务 ",1)]),_:1})])]),y("div",Ke,[y("div",Qe,[a(r,{type:"primary",icon:_(Pe),onClick:le},{default:o(()=>t[7]||(t[7]=[i(" 创建任务 ")])),_:1,__:[7]},8,["icon"]),a(r,{type:"success",onClick:ue,loading:P.value,disabled:m.value.length===0||!K.value,class:W({"button-disabled":m.value.length===0||!K.value})},{default:o(()=>[i(" 批量下载 ("+h(I.value)+") ",1)]),_:1},8,["loading","disabled","class"]),a(r,{type:"warning",onClick:pe,loading:U.value,disabled:m.value.length===0||!Q.value,class:W({"button-disabled":m.value.length===0||!Q.value})},{default:o(()=>[i(" 批量重试 ("+h(O.value)+") ",1)]),_:1},8,["loading","disabled","class"]),a(r,{icon:_(Ue),onClick:Z,loading:_(d).tasksLoading},{default:o(()=>t[8]||(t[8]=[i(" 刷新 ")])),_:1,__:[8]},8,["icon","loading"])])]),y("div",Xe,[a(we,{model:f,inline:"",onSubmit:T(X,["prevent"])},{default:o(()=>[a(V,{label:"状态"},{default:o(()=>[a(q,{modelValue:f.status,"onUpdate:modelValue":t[0]||(t[0]=l=>f.status=l),placeholder:"选择状态",clearable:"",style:{width:"140px"}},{default:o(()=>[a(u,{label:"待处理",value:"pending"}),a(u,{label:"处理中",value:"processing"}),a(u,{label:"已完成",value:"completed"}),a(u,{label:"部分完成",value:"partial_completed"}),a(u,{label:"失败",value:"failed"}),a(u,{label:"已取消",value:"cancelled"})]),_:1},8,["modelValue"])]),_:1}),a(V,{label:"资源类型"},{default:o(()=>[a(q,{modelValue:f.resource_type,"onUpdate:modelValue":t[1]||(t[1]=l=>f.resource_type=l),placeholder:"选择类型",clearable:"",style:{width:"120px"}},{default:o(()=>[a(u,{label:"HLS",value:"hls"}),a(u,{label:"MP4",value:"mp4"}),a(u,{label:"图片",value:"image"})]),_:1},8,["modelValue"])]),_:1}),a(V,{label:"直播间ID"},{default:o(()=>[a(he,{modelValue:f.liveroom_id,"onUpdate:modelValue":t[2]||(t[2]=l=>f.liveroom_id=l),placeholder:"输入直播间ID",clearable:"",style:{width:"160px"}},null,8,["modelValue"])]),_:1}),a(V,null,{default:o(()=>[a(r,{type:"primary",onClick:X},{default:o(()=>t[9]||(t[9]=[i("搜索")])),_:1,__:[9]}),a(r,{onClick:ee},{default:o(()=>t[10]||(t[10]=[i("重置")])),_:1,__:[10]})]),_:1})]),_:1},8,["model"])])]),_:1}),a(G,{class:"table-card",shadow:"never"},{default:o(()=>[a($e,{data:_(d).tasks,border:"",stripe:"",height:"600",onRowClick:se,onSelectionChange:Y,"element-loading-text":"加载中..."},{default:o(()=>[a(p,{type:"selection",width:"55"}),a(p,{prop:"id",label:"任务ID",width:"280","show-overflow-tooltip":""},{default:o(({row:l})=>[a(be,{type:"primary",onClick:T(x=>A(l.id),["stop"])},{default:o(()=>[i(h(g(l.id)),1)]),_:2},1032,["onClick"])]),_:1}),a(p,{prop:"video_id",label:"视频ID",width:"200","show-overflow-tooltip":""}),a(p,{prop:"liveroom_id",label:"直播间ID",width:"120"}),a(p,{prop:"resource_type",label:"资源类型",width:"100"},{default:o(({row:l})=>[a(n,{type:me(l.resource_type),size:"small"},{default:o(()=>[i(h(l.resource_type.toUpperCase()),1)]),_:2},1032,["type"])]),_:1}),a(p,{prop:"status",label:"状态",width:"120"},{default:o(({row:l})=>[a(n,{type:fe(l.status),size:"small"},{default:o(()=>[i(h(_e(l.status)),1)]),_:2},1032,["type"])]),_:1}),a(p,{prop:"progress",label:"进度",width:"120"},{default:o(({row:l})=>[a(Te,{percentage:Math.round(l.progress*100),color:ge(l.status),"show-text":!0,"text-inside":"","stroke-width":"16"},null,8,["percentage","color"])]),_:1}),a(p,{prop:"retry_count",label:"重试次数",width:"100",align:"center"}),a(p,{prop:"created_at",label:"创建时间",width:"160"},{default:o(({row:l})=>[i(h(_(Re)(l.created_at,"MM-DD HH:mm")),1)]),_:1}),a(p,{prop:"updated_at",label:"更新时间",width:"160"},{default:o(({row:l})=>[i(h(_(Fe)(l.updated_at)),1)]),_:1}),a(p,{label:"操作",width:"230",fixed:"right"},{default:o(({row:l})=>[y("div",qe,[a(r,{size:"small",type:"primary",onClick:T(x=>A(l.id),["stop"])},{default:o(()=>t[11]||(t[11]=[i(" 详情 ")])),_:2,__:[11]},1032,["onClick"]),H(l.status)?(z(),E(r,{key:0,size:"small",type:"success",onClick:T(x=>re(l.id),["stop"]),loading:C.value.has(l.id)},{default:o(()=>t[12]||(t[12]=[i(" 开始下载 ")])),_:2,__:[12]},1032,["onClick","loading"])):R("",!0),L(l.status)?(z(),E(r,{key:1,size:"small",type:"warning",onClick:T(x=>ie(l.id),["stop"]),loading:k.value.has(l.id)},{default:o(()=>t[13]||(t[13]=[i(" 重试 ")])),_:2,__:[13]},1032,["onClick","loading"])):R("",!0),ve(l.status)?(z(),E(r,{key:2,size:"small",type:"danger",onClick:T(x=>ce(l.id),["stop"]),loading:F.value.has(l.id)},{default:o(()=>t[14]||(t[14]=[i(" 取消 ")])),_:2,__:[14]},1032,["onClick","loading"])):R("",!0),a(Ce,{onCommand:x=>de(x,l),onClick:t[3]||(t[3]=T(()=>{},["stop"]))},{dropdown:o(()=>[a(ke,null,{default:o(()=>[ye(l.status)?(z(),E(J,{key:0,command:`failures:${l.id}`},{default:o(()=>[a(N,null,{default:o(()=>[a(_(He))]),_:1}),t[16]||(t[16]=i(" 失败记录 "))]),_:2,__:[16]},1032,["command"])):R("",!0),a(J,{command:`videos:${l.id}`},{default:o(()=>[a(N,null,{default:o(()=>[a(_(Le))]),_:1}),t[17]||(t[17]=i(" 已下载视频 "))]),_:2,__:[17]},1032,["command"])]),_:2},1024)]),default:o(()=>[a(r,{size:"small",type:"info"},{default:o(()=>[t[15]||(t[15]=i(" 更多 ")),a(N,null,{default:o(()=>[a(_(Ae))]),_:1})]),_:1,__:[15]})]),_:2},1032,["onCommand"])])]),_:1})]),_:1},8,["data"]),y("div",Ge,[a(xe,{"current-page":w.value,"onUpdate:currentPage":t[4]||(t[4]=l=>w.value=l),"page-size":D.value,"onUpdate:pageSize":t[5]||(t[5]=l=>D.value=l),"page-sizes":[10,20,50,100],total:_(d).tasksTotal,layout:"total, sizes, prev, pager, next, jumper",onSizeChange:te,onCurrentChange:ae},null,8,["current-page","page-size","total"])])]),_:1})])}}},ot=Ne(Je,[["__scopeId","data-v-8993c1e3"]]);export{ot as default};

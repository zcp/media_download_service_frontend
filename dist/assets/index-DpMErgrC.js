const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/DownloadCenter-NVYEDLpj.js","assets/vue-CG64YRnT.js","assets/elementPlus-Djpklj9S.js","assets/_plugin-vue_export-helper-DlAUqK2U.js","assets/utils-Dq7h7Pqt.js","assets/DownloadCenter-D1QFBaWS.css","assets/DownloadTaskList-Bd7SgyTI.js","assets/time-BU10aqh9.js","assets/DownloadTaskList-Cl7YgFNP.css","assets/DownloadTaskCreate-DkIESc6W.js","assets/DownloadTaskCreate-CFllkMka.css","assets/DownloadTaskDetail-DCEbfhnw.js","assets/DownloadTaskDetail-BvNzZj3L.css","assets/DownloadFailures-szlYE_Mw.js","assets/DownloadFailures-COm01qfV.css","assets/DownloadVideosDetail-2q8NZ7Wo.js","assets/DownloadVideosDetail-R7oJxr3c.css","assets/NotFound-BzQxAsOC.js","assets/NotFound-DfQzYYFq.css"])))=>i.map(i=>d[i]);
import{ax as C,h as q,S as N,al as j,y as B,z as D,Q as $,I as R,T as z,H as W,L as M,ay as G,az as H,au as J,aA as Q}from"./vue-CG64YRnT.js";import{E as c,a as K,i as X,b as Y}from"./elementPlus-Djpklj9S.js";import{a as Z}from"./utils-Dq7h7Pqt.js";(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const s of document.querySelectorAll('link[rel="modulepreload"]'))o(s);new MutationObserver(s=>{for(const n of s)if(n.type==="childList")for(const a of n.addedNodes)a.tagName==="LINK"&&a.rel==="modulepreload"&&o(a)}).observe(document,{childList:!0,subtree:!0});function r(s){const n={};return s.integrity&&(n.integrity=s.integrity),s.referrerPolicy&&(n.referrerPolicy=s.referrerPolicy),s.crossOrigin==="use-credentials"?n.credentials="include":s.crossOrigin==="anonymous"?n.credentials="omit":n.credentials="same-origin",n}function o(s){if(s.ep)return;s.ep=!0;const n=r(s);fetch(s.href,n)}})();function ee(e){if(!e)return!0;try{const t=JSON.parse(atob(e.split(".")[1])),r=Date.now()/1e3;return t.exp<=r}catch(t){return console.error("Token解析失败:",t),!0}}function V(e){if(!e)return null;try{const t=JSON.parse(atob(e.split(".")[1]));return{user_id:t.user_id||t.sub,username:t.username,email:t.email}}catch(t){return console.error("Token用户信息解析失败:",t),null}}function te(e){if(!e)return null;try{return JSON.parse(atob(e.split(".")[1])).exp*1e3}catch(t){return console.error("Token过期时间解析失败:",t),null}}function f(e){return e&&!ee(e)}function re(){try{return localStorage.getItem("jwt_token")}catch(e){return console.error("获取存储的Token失败:",e),null}}function se(e){try{localStorage.setItem("jwt_token",e)}catch(t){console.error("存储Token失败:",t)}}function U(){try{localStorage.removeItem("jwt_token")}catch(e){console.error("移除Token失败:",e)}}const S={BASE_URL:"/",DEV:!1,MODE:"production",PROD:!0,SSR:!1,VITE_API_BASE_URL:"/api/v1",VITE_APP_BASE_URL:"/download-center/",VITE_REQUEST_TIMEOUT:"15000",VITE_USER_NODE_ENV:"production"},k=e=>{var o;const t=S==null?void 0:S[e],r=typeof window<"u"?(o=window.__ENV)==null?void 0:o[e]:void 0;return t||r||""},oe=(k("VITE_BASE_API_URL")||"http://localhost:8001/").replace(/\/?$/,"/");(k("VITE_AUTH_API_URL")||"http://localhost:8002/").replace(/\/?$/,"/");const _=k("VITE_LOGIN_URL")||(typeof window<"u"?`${window.location.protocol}//${window.location.host}/pages/auth/login`:"");k("VITE_APP_TITLE");const ne=parseInt(k("VITE_API_TIMEOUT"))||3e4;parseInt(k("VITE_POLLING_INTERVAL"));k("VITE_WS_URL");const y=C("auth",{state:()=>({user:null,token:null,isAuthenticated:!1,tokenExpiry:null,redirectPath:null}),getters:{isTokenValidGetter:e=>e.token?f(e.token):!1,userId:e=>{var t;return((t=e.user)==null?void 0:t.user_id)||null},username:e=>{var t;return((t=e.user)==null?void 0:t.username)||""},userEmail:e=>{var t;return((t=e.user)==null?void 0:t.email)||""},needsReauth:e=>!e.isAuthenticated||!f(e.token)},actions:{setToken(e){if(!e||!f(e))return console.warn("尝试设置无效的Token"),!1;try{const t=V(e);if(!t)throw new Error("无法解析用户信息");return this.token=e,this.user=t,this.tokenExpiry=te(e),this.isAuthenticated=!0,se(e),console.log("Token设置成功:",t),!0}catch(t){return console.error("设置Token失败:",t),this.clearAuth(),!1}},clearAuth(){this.user=null,this.token=null,this.isAuthenticated=!1,this.tokenExpiry=null,U(),console.log("认证信息已清除")},setRedirectPath(e){this.redirectPath=e;try{sessionStorage.setItem("auth_redirect_path",e)}catch(t){console.warn("保存重定向路径失败:",t)}},getRedirectPath(){if(this.redirectPath)return this.redirectPath;try{return sessionStorage.getItem("auth_redirect_path")}catch(e){return console.warn("获取重定向路径失败:",e),null}},clearRedirectPath(){this.redirectPath=null;try{sessionStorage.removeItem("auth_redirect_path")}catch(e){console.warn("清除重定向路径失败:",e)}},async initializeAuth(){console.log("初始化认证状态...");try{const e=re();if(!e)return console.log("未找到保存的Token"),!1;if(f(e)){if(this.setToken(e))return console.log("认证状态恢复成功"),!0}else console.log("保存的Token已过期");return this.clearAuth(),!1}catch(e){return console.error("初始化认证状态失败:",e),this.clearAuth(),!1}},checkTokenExpiry(){if(!this.token)return console.log("Token检查：无Token"),!1;const e=f(this.token);return e||(console.log("Token检查：已过期"),this.clearAuth()),e},parseUserFromToken(e){try{const t=V(e);if(t)this.user=t,console.log("用户信息解析成功:",t);else throw new Error("解析失败")}catch(t){console.error("解析Token用户信息失败:",t),this.clearAuth()}},handleAuthRedirect(){const e=this.getRedirectPath();if(e&&e!=="/login"){console.log("重定向到:",e),this.clearRedirectPath();const t=this.$router||window.$router;t?t.push(e):window.location.href=e}else{console.log("重定向到默认页面");const t=this.$router||window.$router;t?t.push("/download-center/tasks"):window.location.href="/download-center/tasks"}},logout(){console.log("用户登出"),this.clearAuth(),this.clearRedirectPath(),setTimeout(()=>{window.location.href=_},100)},forceReauth(e=null){console.log("强制重新认证"),e&&this.setRedirectPath(e),this.clearAuth(),setTimeout(()=>{window.location.href=_},100)}}}),v=Z.create({baseURL:oe,timeout:ne,headers:{"Content-Type":"application/json"}});let A=null,E=0;function ae(){E===0&&(A=K.service({lock:!0,text:"加载中...",background:"rgba(0, 0, 0, 0.7)"})),E++}function b(){E--,E<=0&&(E=0,A&&(A.close(),A=null))}v.interceptors.request.use(e=>{var r;const t=localStorage.getItem("jwt_token");return t&&f(t)&&(e.headers.Authorization=`Bearer ${t}`),e.hideLoading||ae(),console.log("发送请求:",(r=e.method)==null?void 0:r.toUpperCase(),e.url,e.data||e.params),e},e=>(b(),console.error("请求配置错误:",e),c.error("请求配置错误"),Promise.reject(e)));v.interceptors.response.use(e=>{var s;b(),console.log("收到响应:",(s=e.config.method)==null?void 0:s.toUpperCase(),e.config.url,e.data);const{code:t,message:r,data:o}=e.data;return t===200?o:(console.error("业务错误:",t,r),c.error(r||"请求失败"),Promise.reject(new Error(r||"请求失败")))},e=>{if(b(),console.error("请求错误:",e),e.response){const{status:t,data:r}=e.response;switch(t){case 401:const o=y();o.clearAuth(),U(),o.setRedirectPath(window.location.pathname),c.error("登录已过期，请重新登录"),setTimeout(()=>{window.location.href=_},1e3);break;case 403:c.error("没有权限访问该资源");break;case 404:c.error("请求的资源不存在");break;case 500:c.error("服务器内部错误");break;default:const s=(r==null?void 0:r.message)||`请求失败 (${t})`;c.error(s)}}else e.code==="ECONNABORTED"?c.error("请求超时，请检查网络连接"):e.message==="Network Error"?c.error("网络连接错误，请检查网络"):c.error(e.message||"未知错误");return Promise.reject(e)});function I(e,t={},r={}){return v.get(e,{params:t,...r})}function d(e,t={},r={}){return v.post(e,t,r)}function ie(e,t={}){return v.delete(e,t)}function P(e,t={},r={}){const{page:o=1,size:s=20,sort:n,...a}=t,i={page:o,size:s,...a};return n&&(i.sort=n),I(e,i,r)}const u={getTasks(e={}){return P("/v1/download/tasks",e)},createTask(e){const t=["resource_url","resource_type","video_id","liveroom_id"];for(const o of t)if(!e[o])throw new Error(`缺少必填字段: ${o}`);const r=["hls","mp4","image"];if(!r.includes(e.resource_type))throw new Error(`无效的资源类型: ${e.resource_type}，必须是: ${r.join(", ")}`);return d("/v1/download/tasks",e)},getTaskDetail(e){if(!e)throw new Error("任务ID不能为空");return I(`/v1/download/tasks/${e}`)},deleteTask(e){if(!e)throw new Error("任务ID不能为空");return ie(`/v1/download/tasks/${e}`)},startTask(e){if(!e)throw new Error("任务ID不能为空");return d(`/v1/download/tasks/${e}/start`)},retryTask(e){if(!e)throw new Error("任务ID不能为空");return d(`/v1/download/tasks/${e}/retry`)},getFailures(e,t={}){if(!e)throw new Error("任务ID不能为空");return P(`/v1/download/tasks/${e}/failures`,t)},createFailure(e,t){if(!e)throw new Error("任务ID不能为空");return d(`/v1/download/tasks/${e}/failures`,t)},retryFailure(e,t){if(!e||!t)throw new Error("任务ID和失败记录ID不能为空");return d(`/v1/download/tasks/${e}/failures/${t}/retry`)},abandonFailure(e,t){if(!e||!t)throw new Error("任务ID和失败记录ID不能为空");return d(`/v1/download/tasks/${e}/failures/${t}/abandon`)},createVideo(e,t){if(!e)throw new Error("任务ID不能为空");return d(`/v1/download/tasks/${e}/videos`,t)},getVideos(e,t={}){if(!e)throw new Error("任务ID不能为空");return P(`/v1/download/tasks/${e}/videos`,t)},async batchOperateTasks(e,t){if(!Array.isArray(e)||e.length===0)throw new Error("任务ID列表不能为空");const r=["retry","delete","start"];if(!r.includes(t))throw new Error(`无效的操作类型: ${t}，必须是: ${r.join(", ")}`);const o=[],s=[];for(const n of e)try{let a;switch(t){case"retry":a=await this.retryTask(n);break;case"delete":a=await this.deleteTask(n);break;case"start":a=await this.startTask(n);break}o.push({taskId:n,success:!0,data:a})}catch(a){s.push({taskId:n,success:!1,error:a.message})}return{success:o,errors:s,total:e.length,successCount:o.length,errorCount:s.length}},getTaskStats(){return I("/v1/download/tasks/stats")},searchTasks(e,t={}){if(!e)throw new Error("搜索关键词不能为空");return P("/v1/download/tasks",{...t,search:e})},exportTasks(e={},t="csv"){const r=["csv","excel"];if(!r.includes(t))throw new Error(`无效的导出格式: ${t}，必须是: ${r.join(", ")}`);return I("/v1/download/tasks/export",{...e,format:t},{responseType:"blob"})}},le=C("download",{state:()=>({tasks:[],tasksTotal:0,tasksLoading:!1,tasksError:null,currentTask:null,currentTaskLoading:!1,currentTaskError:null,failures:[],failuresTotal:0,failuresLoading:!1,failuresError:null,videos:[],videosTotal:0,videosLoading:!1,videosError:null,tasksParams:{page:1,size:20,sort:"created_at:desc",status:"",resource_type:"",liveroom_id:""},failuresParams:{page:1,size:20,sort:"created_at:desc",status:"",failure_type:""},videosParams:{page:1,size:20,sort:"created_at:desc",resource_type:""},pollingInterval:null,pollingEnabled:!1,websocketConnection:null}),getters:{getTaskCountByStatus:e=>t=>e.tasks.filter(r=>r.status===t).length,getProcessingTasks:e=>e.tasks.filter(t=>t.status==="processing"||t.status==="pending"),getCompletedTasks:e=>e.tasks.filter(t=>t.status==="completed"||t.status==="partial_completed"),getFailedTasks:e=>e.tasks.filter(t=>t.status==="failed"),hasProcessingTasks:e=>e.tasks.some(t=>t.status==="processing"||t.status==="pending")},actions:{async fetchTasks(e={}){this.tasksLoading=!0,this.tasksError=null;try{const t={...this.tasksParams,...e};this.tasksParams=t;const r=await u.getTasks(t);this.tasks=r.items||[],this.tasksTotal=r.total||0,console.log(`获取任务列表成功: ${this.tasks.length}/${this.tasksTotal}`)}catch(t){console.error("获取任务列表失败:",t),this.tasksError=t.message,this.tasks=[],this.tasksTotal=0}finally{this.tasksLoading=!1}},async refreshTasks(){await this.fetchTasks(this.tasksParams)},async createTask(e){try{const t=await u.createTask(e);return this.tasks.unshift(t),this.tasksTotal+=1,console.log("任务创建成功:",t.id),t}catch(t){throw console.error("创建任务失败:",t),t}},async deleteTask(e){var t;try{await u.deleteTask(e);const r=this.tasks.findIndex(o=>o.id===e);r!==-1&&(this.tasks.splice(r,1),this.tasksTotal-=1),((t=this.currentTask)==null?void 0:t.id)===e&&(this.currentTask=null),console.log("任务删除成功:",e)}catch(r){throw console.error("删除任务失败:",r),r}},async retryTask(e){var t;try{const r=await u.retryTask(e);return this.updateTaskInList(r),((t=this.currentTask)==null?void 0:t.id)===e&&(this.currentTask=r),console.log("任务重试成功:",e),r}catch(r){throw console.error("重试任务失败:",r),r}},async fetchTaskDetail(e){this.currentTaskLoading=!0,this.currentTaskError=null;try{const t=await u.getTaskDetail(e);return this.currentTask=t,this.updateTaskInList(t),console.log("获取任务详情成功:",e),t}catch(t){throw console.error("获取任务详情失败:",t),this.currentTaskError=t.message,this.currentTask=null,t}finally{this.currentTaskLoading=!1}},clearCurrentTask(){this.currentTask=null,this.currentTaskError=null},async fetchFailures(e,t={}){this.failuresLoading=!0,this.failuresError=null;try{const r={...this.failuresParams,...t};this.failuresParams=r;const o=await u.getFailures(e,r);this.failures=o.items||[],this.failuresTotal=o.total||0,console.log(`获取失败记录成功: ${this.failures.length}/${this.failuresTotal}`)}catch(r){console.error("获取失败记录失败:",r),this.failuresError=r.message,this.failures=[],this.failuresTotal=0}finally{this.failuresLoading=!1}},async retryFailure(e,t){try{await u.retryFailure(e,t),await this.fetchFailures(e,this.failuresParams),console.log("失败记录重试成功:",t)}catch(r){throw console.error("重试失败记录失败:",r),r}},async abandonFailure(e,t){try{await u.abandonFailure(e,t),await this.fetchFailures(e,this.failuresParams),console.log("失败记录放弃成功:",t)}catch(r){throw console.error("放弃失败记录失败:",r),r}},async fetchVideos(e,t={}){this.videosLoading=!0,this.videosError=null;try{const r={...this.videosParams,...t};this.videosParams=r;const o=await u.getVideos(e,r);this.videos=o.items||[],this.videosTotal=o.total||0,console.log(`获取已下载视频成功: ${this.videos.length}/${this.videosTotal}`)}catch(r){console.error("获取已下载视频失败:",r),this.videosError=r.message,this.videos=[],this.videosTotal=0}finally{this.videosLoading=!1}},updateTaskInList(e){const t=this.tasks.findIndex(r=>r.id===e.id);t!==-1&&(this.tasks[t]={...this.tasks[t],...e})},resetAllState(){this.tasks=[],this.tasksTotal=0,this.currentTask=null,this.failures=[],this.failuresTotal=0,this.videos=[],this.videosTotal=0,this.tasksError=null,this.currentTaskError=null,this.failuresError=null,this.videosError=null,this.stopPolling(),this.disconnectWebSocket()},startPolling(e=5e3){this.stopPolling(),this.pollingEnabled=!0,this.pollingInterval=setInterval(async()=>{this.pollingEnabled&&(this.hasProcessingTasks&&await this.refreshTasks(),this.currentTask&&(this.currentTask.status==="processing"||this.currentTask.status==="pending")&&await this.fetchTaskDetail(this.currentTask.id))},e),console.log(`开始轮询更新，间隔: ${e}ms`)},stopPolling(){this.pollingInterval&&(clearInterval(this.pollingInterval),this.pollingInterval=null),this.pollingEnabled=!1,console.log("停止轮询更新")},connectWebSocket(){console.log("WebSocket连接功能待实现")},disconnectWebSocket(){this.websocketConnection&&(this.websocketConnection.close(),this.websocketConnection=null)}}}),ce={id:"app"},ue={__name:"App",setup(e){const t=y(),r=le();q(()=>{console.log("App组件已挂载"),document.addEventListener("visibilitychange",o),window.addEventListener("beforeunload",s)}),N(()=>{console.log("App组件已卸载"),document.removeEventListener("visibilitychange",o),window.removeEventListener("beforeunload",s),r.stopPolling(),r.disconnectWebSocket()});const o=()=>{document.hidden?(r.stopPolling(),console.log("页面隐藏，停止轮询")):t.isAuthenticated&&r.hasProcessingTasks&&(r.startPolling(5e3),console.log("页面显示，重新开始轮询"))},s=n=>{if(r.getProcessingTasks.length>0){const i="您有正在进行的下载任务，确定要离开吗？";return n.returnValue=i,i}};return(n,a)=>{const i=j("router-view");return D(),B("div",ce,[$(i,null,{default:R(({Component:m})=>[$(z,{name:"page",mode:"out-in"},{default:R(()=>[(D(),W(M(m)))]),_:2},1024)]),_:1})])}}},he="modulepreload",de=function(e){return"/"+e},O={},g=function(t,r,o){let s=Promise.resolve();if(r&&r.length>0){let a=function(l){return Promise.all(l.map(w=>Promise.resolve(w).then(T=>({status:"fulfilled",value:T}),T=>({status:"rejected",reason:T}))))};document.getElementsByTagName("link");const i=document.querySelector("meta[property=csp-nonce]"),m=(i==null?void 0:i.nonce)||(i==null?void 0:i.getAttribute("nonce"));s=a(r.map(l=>{if(l=de(l),l in O)return;O[l]=!0;const w=l.endsWith(".css"),T=w?'[rel="stylesheet"]':"";if(document.querySelector(`link[href="${l}"]${T}`))return;const h=document.createElement("link");if(h.rel=w?"stylesheet":he,w||(h.as="script"),h.crossOrigin="",h.href=l,m&&h.setAttribute("nonce",m),document.head.appendChild(h),w)return new Promise((x,F)=>{h.addEventListener("load",x),h.addEventListener("error",()=>F(new Error(`Unable to preload CSS for ${l}`)))})}))}function n(a){const i=new Event("vite:preloadError",{cancelable:!0});if(i.payload=a,window.dispatchEvent(i),!i.defaultPrevented)throw a}return s.then(a=>{for(const i of a||[])i.status==="rejected"&&n(i.reason);return t().catch(n)})},fe=()=>g(()=>import("./DownloadCenter-NVYEDLpj.js"),__vite__mapDeps([0,1,2,3,4,5])),pe=()=>g(()=>import("./DownloadTaskList-Bd7SgyTI.js"),__vite__mapDeps([6,1,7,2,3,4,8])),ke=()=>g(()=>import("./DownloadTaskCreate-DkIESc6W.js"),__vite__mapDeps([9,1,2,3,4,10])),ge=()=>g(()=>import("./DownloadTaskDetail-DCEbfhnw.js"),__vite__mapDeps([11,1,7,2,3,4,12])),we=()=>g(()=>import("./DownloadFailures-szlYE_Mw.js"),__vite__mapDeps([13,1,7,2,3,4,14])),me=()=>g(()=>import("./DownloadVideosDetail-2q8NZ7Wo.js"),__vite__mapDeps([15,1,7,2,3,4,16])),Te=["/download-center","/download-center/tasks","/download-center/tasks/create","/download-center/tasks/:taskId","/download-center/tasks/:taskId/failures","/download-center/tasks/:taskId/videos"];function Ee(e){return Te.some(t=>{const r=t.replace(":taskId","[^/]+");return new RegExp(`^${r}(/.*)?$`).test(e)})}const _e=[{path:"/",redirect:"/download-center"},{path:"/download-center",name:"DownloadCenter",component:fe,meta:{title:"下载中心",requiresAuth:!0},children:[{path:"",redirect:"/download-center/tasks"},{path:"tasks",name:"DownloadTaskList",component:pe,meta:{title:"下载任务列表",requiresAuth:!0}},{path:"tasks/create",name:"DownloadTaskCreate",component:ke,meta:{title:"创建下载任务",requiresAuth:!0}},{path:"tasks/:taskId",name:"DownloadTaskDetail",component:ge,props:!0,meta:{title:"任务详情",requiresAuth:!0}},{path:"tasks/:taskId/failures",name:"DownloadFailures",component:we,props:!0,meta:{title:"下载失败记录",requiresAuth:!0}},{path:"tasks/:taskId/videos",name:"DownloadVideosDetail",component:me,props:!0,meta:{title:"已下载视频",requiresAuth:!0}}]},{path:"/:pathMatch(.*)*",name:"NotFound",component:()=>g(()=>import("./NotFound-BzQxAsOC.js"),__vite__mapDeps([17,1,3,18])),meta:{title:"页面未找到"}}],L=G({history:H("/"),routes:_e,scrollBehavior(e,t,r){return r||{top:0}}});L.beforeEach(async(e,t,r)=>{var s,n;if(console.log(`路由导航: ${t.path} -> ${e.path}`),(s=e.meta)!=null&&s.title&&(document.title=`${e.meta.title} - 媒体下载服务`),((n=e.meta)==null?void 0:n.requiresAuth)||Ee(e.path)){const a=y();console.log("检查认证状态...");const i=localStorage.getItem("jwt_token");if(!i){console.log("未找到Token，跳转登录"),a.setRedirectPath(e.fullPath),window.location.href=_;return}if(!f(i)){console.log("Token已过期，跳转登录"),a.clearAuth(),a.setRedirectPath(e.fullPath),window.location.href=_;return}if(!a.isAuthenticated&&(console.log("恢复认证状态..."),!a.setToken(i))){console.error("恢复认证状态失败"),a.forceReauth(e.fullPath);return}console.log("认证检查通过"),a.isAuthenticated=!0}r()});L.afterEach((e,t)=>{console.log(`路由导航完成: ${e.path}`)});L.onError(e=>{console.error("路由错误:",e),e.message.includes("Loading chunk")&&window.location.reload()});const p=J(ue),ye=Q();p.use(ye);p.use(L);p.use(X);for(const[e,t]of Object.entries(Y))p.component(e,t);p.config.errorHandler=(e,t,r)=>{console.error("全局错误:",e),console.error("错误信息:",r),console.error("组件实例:",t)};async function ve(){try{console.log("正在初始化应用..."),await y().initializeAuth(),console.log("应用初始化完成"),p.mount("#app"),console.log("应用启动成功")}catch(e){console.error("应用初始化失败:",e),y().clearAuth(),p.mount("#app")}}ve();export{le as a,y as u};

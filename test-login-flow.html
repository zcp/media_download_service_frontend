<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç™»å½•æµç¨‹æµ‹è¯•</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; line-height: 1.6; }
        .section { margin-bottom: 30px; padding: 20px; border: 1px solid #ddd; border-radius: 8px; }
        .success { background-color: #d4edda; border-color: #c3e6cb; }
        .error { background-color: #f8d7da; border-color: #f5c6cb; }
        .warning { background-color: #fff3cd; border-color: #ffeaa7; }
        .info { background-color: #d1ecf1; border-color: #bee5eb; }
        button { padding: 12px 20px; margin: 8px; cursor: pointer; border: none; border-radius: 4px; font-size: 14px; }
        .btn-primary { background: #007bff; color: white; }
        .btn-success { background: #28a745; color: white; }
        .btn-warning { background: #ffc107; color: black; }
        .btn-danger { background: #dc3545; color: white; }
        pre { background: #f8f9fa; padding: 15px; border-radius: 4px; overflow-x: auto; }
        .step { margin: 10px 0; padding: 10px; background: #f8f9fa; border-left: 4px solid #007bff; }
        .log { max-height: 200px; overflow-y: auto; font-family: monospace; font-size: 12px; }
    </style>
</head>
<body>
    <h1>ğŸ” ç™»å½•æµç¨‹æµ‹è¯•å·¥å…·</h1>
    
    <div class="section info">
        <h2>ğŸ“– ä½¿ç”¨è¯´æ˜</h2>
        <p>è¿™ä¸ªå·¥å…·å¸®åŠ©æ‚¨æµ‹è¯•å’Œè°ƒè¯•æ•´ä¸ªç™»å½•æµç¨‹ã€‚æŒ‰ç…§æ­¥éª¤è¿›è¡Œæµ‹è¯•ï¼š</p>
        <div class="step">1. æ¸…é™¤ç°æœ‰æ•°æ®</div>
        <div class="step">2. æµ‹è¯•è·³è½¬åˆ°ç™»å½•é¡µé¢</div>
        <div class="step">3. æ¨¡æ‹Ÿç™»å½•æˆåŠŸå›è°ƒ</div>
        <div class="step">4. éªŒè¯æœ€ç»ˆè·³è½¬</div>
    </div>
    
    <div class="section">
        <h2>ğŸ§¹ ç¬¬ä¸€æ­¥ï¼šæ¸…ç†ç¯å¢ƒ</h2>
        <button class="btn-warning" onclick="clearAll()">æ¸…é™¤æ‰€æœ‰æ•°æ®</button>
        <button class="btn-primary" onclick="checkCurrentState()">æ£€æŸ¥å½“å‰çŠ¶æ€</button>
        <div id="clear-result"></div>
    </div>
    
    <div class="section">
        <h2>ğŸš€ ç¬¬äºŒæ­¥ï¼šæµ‹è¯•ç™»å½•è·³è½¬</h2>
        <p>æ¨¡æ‹Ÿè®¿é—®å—ä¿æŠ¤é¡µé¢ï¼Œåº”è¯¥è·³è½¬åˆ°ç™»å½•é¡µé¢ï¼š</p>
        <button class="btn-primary" onclick="testLoginRedirect()">æµ‹è¯•è·³è½¬åˆ°ç™»å½•é¡µé¢</button>
        <div id="redirect-result"></div>
    </div>
    
    <div class="section">
        <h2>ğŸ« ç¬¬ä¸‰æ­¥ï¼šæ¨¡æ‹Ÿç™»å½•æˆåŠŸ</h2>
        <p>æ¨¡æ‹Ÿä»ç™»å½•é¡µé¢è¿”å›çš„Tokenï¼š</p>
        <input type="text" id="test-token" placeholder="è¾“å…¥æµ‹è¯•Tokenï¼ˆå¯é€‰ï¼Œä¼šè‡ªåŠ¨ç”Ÿæˆï¼‰" style="width: 300px; padding: 8px;">
        <br><br>
        <button class="btn-success" onclick="simulateLoginSuccess()">æ¨¡æ‹Ÿç™»å½•æˆåŠŸ</button>
        <button class="btn-primary" onclick="generateTestToken()">ç”Ÿæˆæµ‹è¯•Token</button>
        <div id="login-result"></div>
    </div>
    
    <div class="section">
        <h2>ğŸ” ç¬¬å››æ­¥ï¼šéªŒè¯å®Œæ•´æµç¨‹</h2>
        <button class="btn-success" onclick="testCompleteFlow()">æµ‹è¯•å®Œæ•´æµç¨‹</button>
        <div id="complete-result"></div>
    </div>
    
    <div class="section">
        <h2>ğŸ“Š å®æ—¶æ—¥å¿—</h2>
        <button class="btn-warning" onclick="clearLogs()">æ¸…é™¤æ—¥å¿—</button>
        <div id="logs" class="log"></div>
    </div>

    <script>
        let logContainer = document.getElementById('logs');
        
        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = document.createElement('div');
            logEntry.innerHTML = `[${timestamp}] ${message}`;
            logEntry.style.color = type === 'error' ? 'red' : type === 'success' ? 'green' : 'black';
            logContainer.appendChild(logEntry);
            logContainer.scrollTop = logContainer.scrollHeight;
            console.log(message);
        }
        
        function clearLogs() {
            logContainer.innerHTML = '';
        }
        
        function clearAll() {
            localStorage.clear();
            sessionStorage.clear();
            document.getElementById('clear-result').innerHTML = '<div class="success">âœ… æ‰€æœ‰æ•°æ®å·²æ¸…é™¤</div>';
            log('ğŸ§¹ æ¸…é™¤äº†æ‰€æœ‰localStorageå’ŒsessionStorageæ•°æ®', 'success');
        }
        
        function checkCurrentState() {
            const token = localStorage.getItem('jwt_token');
            const redirectPath = localStorage.getItem('auth_redirect_path');
            
            let html = '<h3>å½“å‰çŠ¶æ€:</h3>';
            let hasToken = false;
            
            if (token) {
                hasToken = true;
                html += '<div class="success">âœ… å­˜åœ¨Token</div>';
                try {
                    const payload = JSON.parse(atob(token.split('.')[1]));
                    const currentTime = Date.now() / 1000;
                    const isExpired = payload.exp <= currentTime;
                    
                    html += `<div class="${isExpired ? 'error' : 'success'}">
                        ${isExpired ? 'âŒ' : 'âœ…'} Token ${isExpired ? 'å·²è¿‡æœŸ' : 'æœ‰æ•ˆ'}
                    </div>`;
                    
                    if (!isExpired) {
                        const timeLeft = Math.round(payload.exp - currentTime);
                        html += `<p>å‰©ä½™æ—¶é—´: ${timeLeft} ç§’</p>`;
                    }
                } catch (e) {
                    html += '<div class="error">âŒ Tokenæ ¼å¼é”™è¯¯</div>';
                }
            } else {
                html += '<div class="warning">âš ï¸ æ²¡æœ‰Token</div>';
            }
            
            if (redirectPath) {
                html += `<div class="info">ğŸ“ ä¿å­˜çš„é‡å®šå‘è·¯å¾„: ${redirectPath}</div>`;
            }
            
            document.getElementById('clear-result').innerHTML = html;
            log(`ğŸ“Š æ£€æŸ¥çŠ¶æ€: Token=${hasToken ? 'å­˜åœ¨' : 'æ— '}, RedirectPath=${redirectPath || 'æ— '}`);
        }
        
        function testLoginRedirect() {
            // ä¿å­˜æµ‹è¯•è·¯å¾„
            localStorage.setItem('auth_redirect_path', '/download-center/tasks');
            
            // æ„å»ºç™»å½•URL
            const callbackUrl = `${window.location.origin}/simple-callback.html`;
            const loginUrl = `http://localhost:5173/pages/auth/login?redirect_uri=${encodeURIComponent(callbackUrl)}`;
            
            document.getElementById('redirect-result').innerHTML = `
                <div class="info">
                    <h4>ğŸ“‹ è·³è½¬ä¿¡æ¯:</h4>
                    <p><strong>å›è°ƒåœ°å€:</strong> ${callbackUrl}</p>
                    <p><strong>ç™»å½•åœ°å€:</strong> ${loginUrl}</p>
                    <p><strong>ä¿å­˜çš„é‡å®šå‘è·¯å¾„:</strong> /download-center/tasks</p>
                </div>
                <button class="btn-primary" onclick="window.open('${loginUrl}', '_blank')">åœ¨æ–°çª—å£æ‰“å¼€ç™»å½•é¡µé¢</button>
            `;
            
            log(`ğŸš€ å‡†å¤‡è·³è½¬åˆ°ç™»å½•é¡µé¢: ${loginUrl}`, 'info');
        }
        
        function generateTestToken() {
            const header = btoa(JSON.stringify({typ: "JWT", alg: "HS256"}));
            const payload = btoa(JSON.stringify({
                user_id: "test-user-123",
                username: "æµ‹è¯•ç”¨æˆ·",
                email: "test@example.com",
                exp: Math.floor(Date.now() / 1000) + 3600 // 1å°æ—¶åè¿‡æœŸ
            }));
            const signature = "test-signature";
            const testToken = `${header}.${payload}.${signature}`;
            
            document.getElementById('test-token').value = testToken;
            log('ğŸ« ç”Ÿæˆäº†æµ‹è¯•Token', 'success');
        }
        
        function simulateLoginSuccess() {
            let token = document.getElementById('test-token').value;
            
            if (!token) {
                generateTestToken();
                token = document.getElementById('test-token').value;
            }
            
            // æ¨¡æ‹Ÿå›è°ƒé¡µé¢çš„å¤„ç†
            const callbackUrl = `${window.location.origin}/auth/callback?token=${encodeURIComponent(token)}`;
            
            document.getElementById('login-result').innerHTML = `
                <div class="success">
                    <h4>âœ… æ¨¡æ‹Ÿç™»å½•æˆåŠŸ</h4>
                    <p><strong>Token:</strong> ${token.substring(0, 50)}...</p>
                    <p><strong>å›è°ƒåœ°å€:</strong> ${callbackUrl}</p>
                </div>
                <button class="btn-success" onclick="window.open('${callbackUrl}', '_blank')">åœ¨æ–°çª—å£æµ‹è¯•å›è°ƒ</button>
            `;
            
            log(`âœ… æ¨¡æ‹Ÿç™»å½•æˆåŠŸï¼ŒToken: ${token.substring(0, 20)}...`, 'success');
        }
        
        function testCompleteFlow() {
            log('ğŸ”„ å¼€å§‹å®Œæ•´æµç¨‹æµ‹è¯•...', 'info');
            
            // ç¬¬ä¸€æ­¥ï¼šæ¸…é™¤æ•°æ®
            clearAll();
            
            setTimeout(() => {
                // ç¬¬äºŒæ­¥ï¼šè®¾ç½®é‡å®šå‘è·¯å¾„
                localStorage.setItem('auth_redirect_path', '/download-center/tasks');
                log('ğŸ“ è®¾ç½®é‡å®šå‘è·¯å¾„: /download-center/tasks', 'info');
                
                setTimeout(() => {
                    // ç¬¬ä¸‰æ­¥ï¼šç”ŸæˆToken
                    generateTestToken();
                    const token = document.getElementById('test-token').value;
                    
                    setTimeout(() => {
                        // ç¬¬å››æ­¥ï¼šæ¨¡æ‹Ÿå®Œæ•´å›è°ƒ
                        const callbackUrl = `${window.location.origin}/auth/callback?token=${encodeURIComponent(token)}`;
                        
                        document.getElementById('complete-result').innerHTML = `
                            <div class="success">
                                <h4>ğŸ‰ å®Œæ•´æµç¨‹å‡†å¤‡å°±ç»ª</h4>
                                <p>1. âœ… æ¸…é™¤äº†æ—§æ•°æ®</p>
                                <p>2. âœ… è®¾ç½®äº†é‡å®šå‘è·¯å¾„</p>
                                <p>3. âœ… ç”Ÿæˆäº†æµ‹è¯•Token</p>
                                <p>4. ğŸš€ å¯ä»¥æµ‹è¯•å›è°ƒ</p>
                            </div>
                            <button class="btn-success" onclick="window.location.href='${callbackUrl}'">æ‰§è¡Œå›è°ƒæµ‹è¯•</button>
                        `;
                        
                        log('ğŸ‰ å®Œæ•´æµç¨‹å‡†å¤‡å®Œæˆï¼Œå¯ä»¥æ‰§è¡Œæµ‹è¯•', 'success');
                    }, 500);
                }, 500);
            }, 500);
        }
        
        // é¡µé¢åŠ è½½æ—¶æ£€æŸ¥çŠ¶æ€
        window.onload = function() {
            checkCurrentState();
            log('ğŸ“± æµ‹è¯•å·¥å…·å·²åŠ è½½', 'info');
        };
    </script>
</body>
</html>
